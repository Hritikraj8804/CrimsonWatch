version: '3.8'

services:
  # Archestra Platform (All-in-one)
  archestra:
    image: archestra/platform:latest
    ports:
      - "9000:9000" # MCP Gateway
      - "3000:3000" # Archestra UI
      # - "9090:9090"  # Prometheus metrics (Provided by standalone container below)
    command: [ "sh", "-c", "echo $ARCHESTRA_API_KEY > /app/data/.auth_secret; /docker-entrypoint.sh; tail -f /dev/null" ]
    environment:
      - ARCHESTRA_QUICKSTART=true
      - ARCHESTRA_API_KEY=${ARCHESTRA_API_KEY}
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - archestra-postgres-data:/var/lib/postgresql/data
      - archestra-app-data:/app/data
    networks:
      - crimsonwatch-network

  # Standalone Prometheus (Reliable)
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - crimsonwatch-network

  # CrimsonWatch Dashboard
  dashboard:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_ARCHESTRA_URL=${VITE_ARCHESTRA_URL}
        - VITE_PROMETHEUS_URL=${VITE_PROMETHEUS_URL}
        - VITE_API_KEY=${ARCHESTRA_API_KEY}
    ports:
      - "5173:80"
    environment:
      - VITE_ARCHESTRA_URL=${VITE_ARCHESTRA_URL}
      - VITE_PROMETHEUS_URL=${VITE_PROMETHEUS_URL}
      - VITE_API_KEY=${ARCHESTRA_API_KEY}
    depends_on:
      - archestra
    networks:
      - crimsonwatch-network

volumes:
  archestra-postgres-data:
  archestra-app-data:


networks:
  crimsonwatch-network:
    driver: bridge
